#!/usr/bin/env bash

bp_dir=$(cd $(dirname $0); cd ..; pwd)
source $bp_dir/bin/common.sh

build_dir=$1
run_dir="/app"
cache_dir=$2
env_dir=$3
vendor_dir=$(stagetime_path "vendor")
mono_url="https://ci-labs-buildpack-downloads.s3.amazonaws.com/mono/lucid/x86_64/mono-3.4.0_full.tar.gz"

# The target exe (maybe this should be communicated by file from detect step)
# This must be done prior to download and unzip of mono otherwise we will pick
# up stuff from the mono runtime.
target=$(runtime_path $(get_target))

# fetch mono
status "Downloading and installing mono"
mkdir -p $vendor_dir
curl $mono_url -s -o - | tar xzf - -C $vendor_dir

# update certificates - not sure about this as runtime path ony available at runtime,
# may need to move the stuff below into bootstrap.
#ln -s $(stagetime_path "vendor") $(runtime_path "vendor")
#$(stagetime_path "vendor/mono/bin/mozroots") --import --sync

# make bootstrap
mono=$(runtime_path "vendor/mono/bin/mono")
bootstrap=$(stagetime_path "bootstrap")

# the actual file.
cat << EOF > $bootstrap
#!/usr/bin/env bash
$mono $target
EOF

# Make it executable
chmod 777 $bootstrap


